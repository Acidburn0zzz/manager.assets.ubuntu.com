<VirtualHost *:80>
    CustomLog /var/log/apache2/wsgi-app-access.log combined_with_request_time
    ErrorLog /var/log/apache2/wsgi-app-error.log
    
    RewriteEngine on

    RewriteRule .* https://%{HTTP_HOST}%{REQUEST_URI} [R,L]
</VirtualHost>

<VirtualHost *:443>
    CustomLog /var/log/apache2/wsgi-app-access.log combined_with_request_time
    ErrorLog /var/log/apache2/wsgi-app-error.log

    WSGIScriptAlias / {{ wsgi_path }}
    WSGICallableObject {{ wsgi_app_name }}
    WSGIPassAuthorization On


    SSLEngine on
    SSLCertificateKeyFile {{ keyfile_path }}
    SSLCertificateFile {{ certificate_path }}

    Alias   /{{ static_url_path }} {{ static_path }}
    
    <Directory {{ static_path }}>
        Require all granted
    </Directory>

    <Directory {{ wsgi_dir }}>
        <Files {{ wsgi_file }}>
            Require all granted
        </Files>
    </Directory>

    <Location "/">
        PythonAccessHandler apache_openid::protect
        PythonOption handler openidteams
        PythonOption authorized-teams "canonical-webmonkeys"
        PythonOption action-path "/openid/"
    </Location>

    <Location "/openid/">
        SetHandler mod_python
        PythonHandler apache_openid::protect
        PythonOption handler openidteams
        PythonOption store-type file
        PythonOption store-directory /tmp/apache-openid/
        PythonOption allowed-op-list-url "file://{{ live_link_path }}/conf/allowed-ops.txt"
        PythonOption action-path "/openid/"
    </Location>

    ProxyPass /openid/ !
</VirtualHost>
